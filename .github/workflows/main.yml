name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  test:
    # Use a standard runner environment, such as ubuntu-latest
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the repository code
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Step 2: Set up Java environment (Assuming 'mvn' implies a Java project)
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '17' # Adjust to your project's required Java version
          distribution: 'temurin'
          cache: 'maven'

      # Step 3: Set up Docker Compose (If not pre-installed on the runner)
      # Modern GitHub runners (ubuntu-latest) usually have Docker and Docker Compose pre-installed.
      # This step is included for clarity/older runners, but might be redundant.
      - name: Install Docker Compose
        run: |
          # The service container approach used in GitLab (docker:dind) is replaced 
          # by running services directly on the host or using 'docker compose'.
          echo "Docker and Docker Compose are assumed to be pre-installed on the runner."

      # Step 4: Start services using docker compose
      - name: Start Services
        run: docker compose up --detach --wait hub chrome-node

      # Step 5: Run tests (and build, if 'mvn clean verify' implies that)
      # This assumes your 'tests' service/container name is where the test execution happens
      # and that your 'docker compose run' command is correct for your setup.
      - name: Run Tests
        run: docker compose run tests mvn clean verify
        # Add a 'continue-on-error: true' if you want artifact upload even if tests fail
        # continue-on-error: true 

      # Step 6: Upload artifacts (equivalent to the 'artifacts' section in GitLab CI)
      # This step runs even if the previous 'Run Tests' step fails (unless the workflow is cancelled)
      - name: Upload Test Reports
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports
          path: target/surefire-reports/
          # In GitHub Actions, the expiration is set on the upload-artifact action.
          # The default retention is 90 days, but we can set a custom one (e.g., 30 days)
          retention-days: 30

      # Step 7: Clean up/Stop services
      - name: Stop Services
        if: always() # Ensure this runs even if previous steps fail
        run: docker compose down
